{"version":3,"file":"index.js","names":["createRevision","clone","randomCouchString","blobToBase64String","prepareQuery","ensureNotFalsy","toArray","arrayFilterNotEmpty","migrateStorage","params","collections","Object","values","database","batchSize","parallel","Promise","all","map","collection","migrateCollection","oldDatabaseName","oldStorage","afterMigrateBatch","logFunction","log","message","name","schema","jsonSchema","primaryPath","oldDatabaseInstanceToken","rxdbVersion","indexes","index","filter","field","includes","oldStorageInstance","createStorageInstance","databaseName","collectionName","multiInstance","options","databaseInstanceToken","devMode","plainQuery","selector","_deleted","$eq","limit","sort","skip","preparedQuery","statics","_loop","queryResult","query","docs","documents","length","remove","v","docsNonMutated","attachments","doc","docId","entries","_attachments","attachmentId","attachmentMeta","attachmentData","getAttachmentData","digest","attachmentDataString","data","type","insertToNewWriteRows","document","writeToNewResult","storageInstance","bulkWrite","writeToOldRows","_doc","idx","previous","_meta","lwt","Date","getTime","newDoc","_rev","writeToOldResult","keys","error","console","dir","errors","Error","err","cleanup","catch","_ret"],"sources":["../../../../src/plugins/migration-storage/index.ts"],"sourcesContent":["import {\r\n    RxDatabase,\r\n    RxCollection,\r\n    createRevision,\r\n    clone,\r\n    BulkWriteRow,\r\n    RxStorageBulkWriteResponse,\r\n    randomCouchString,\r\n    RxStorage,\r\n    blobToBase64String,\r\n    prepareQuery,\r\n    PreparedQuery,\r\n    FilledMangoQuery,\r\n    ensureNotFalsy,\r\n    toArray,\r\n    arrayFilterNotEmpty\r\n} from '../../index.ts';\r\n\r\nexport type RxStorageOld<A, B> = RxStorage<A, B> | any;\r\n\r\nexport type AfterMigrateBatchHandlerInput = {\r\n    databaseName: string;\r\n    collectionName: string;\r\n    oldDatabaseName: string;\r\n    insertToNewWriteRows: BulkWriteRow<any>[];\r\n    writeToNewResult: RxStorageBulkWriteResponse<any>;\r\n};\r\nexport type AfterMigrateBatchHandler = (\r\n    input: AfterMigrateBatchHandlerInput\r\n) => any | Promise<any>;\r\n\r\n\r\nexport type MigrateStorageParams = {\r\n    database: RxDatabase;\r\n    /**\r\n     * Using the migration plugin requires you\r\n     * to rename your new old database.\r\n     * The original name of the v11 database must be provided here.\r\n     */\r\n    oldDatabaseName: string;\r\n    oldStorage: RxStorageOld<any, any>;\r\n    batchSize?: number;\r\n    parallel?: boolean;\r\n    afterMigrateBatch?: AfterMigrateBatchHandler;\r\n    // to log each step, pass console.log.bind(console) here.\r\n    logFunction?: (message: string) => void;\r\n}\r\n\r\n/**\r\n * Migrates collections of RxDB version A and puts them\r\n * into a RxDatabase that is created with version B.\r\n * This function only works from the previous major version upwards.\r\n * Do not use it to migrate like rxdb v9 to v14. \r\n */\r\nexport async function migrateStorage(\r\n    params: MigrateStorageParams\r\n): Promise<void> {\r\n    const collections = Object.values(params.database.collections);\r\n    const batchSize = params.batchSize ? params.batchSize : 10;\r\n    if (params.parallel) {\r\n        await Promise.all(\r\n            collections.map(collection => migrateCollection(\r\n                collection,\r\n                params.oldDatabaseName,\r\n                params.oldStorage,\r\n                batchSize,\r\n                params.afterMigrateBatch,\r\n                params.logFunction\r\n            ))\r\n        );\r\n    } else {\r\n        for (const collection of collections) {\r\n            await migrateCollection(\r\n                collection,\r\n                params.oldDatabaseName,\r\n                params.oldStorage,\r\n                batchSize,\r\n                params.afterMigrateBatch,\r\n                params.logFunction\r\n            );\r\n        }\r\n    }\r\n}\r\n\r\nexport async function migrateCollection<RxDocType>(\r\n    collection: RxCollection<RxDocType>,\r\n    oldDatabaseName: string,\r\n    oldStorage: RxStorageOld<any, any>,\r\n    batchSize: number,\r\n    afterMigrateBatch?: AfterMigrateBatchHandler,\r\n    // to log each step, pass console.log.bind(console) here.\r\n    logFunction?: (message: string) => void\r\n) {\r\n    function log(message: string) {\r\n        if (logFunction) {\r\n            logFunction('migrateCollection(' + collection.name + ')' + message);\r\n        }\r\n    }\r\n    log('start migrateCollection()');\r\n    let schema = collection.schema.jsonSchema;\r\n    const primaryPath = collection.schema.primaryPath;\r\n    const oldDatabaseInstanceToken = randomCouchString(10);\r\n\r\n\r\n    /**\r\n     * In RxDB v15 we changed how the indexes are created.\r\n     * Before (v14), the storage prepended the _deleted field\r\n     * to all indexes.\r\n     * In v15, RxDB will prepend the _deleted field BEFORE sending\r\n     * it to the storage. Therefore we have to strip these fields\r\n     * when crating v14 storage instances.\r\n     */\r\n    if (!oldStorage.rxdbVersion && schema.indexes) {\r\n        schema = clone(schema);\r\n        schema.indexes = ensureNotFalsy(schema.indexes).map(index => {\r\n            index = toArray(index).filter(field => field !== '_deleted');\r\n            if (index.includes('_meta.lwt')) {\r\n                return null;\r\n            }\r\n            return index;\r\n        }).filter(arrayFilterNotEmpty);\r\n\r\n    }\r\n\r\n    const oldStorageInstance = await oldStorage.createStorageInstance({\r\n        databaseName: oldDatabaseName,\r\n        collectionName: collection.name,\r\n        multiInstance: false,\r\n        options: {},\r\n        schema: schema,\r\n        databaseInstanceToken: oldDatabaseInstanceToken,\r\n        devMode: false\r\n    });\r\n\r\n\r\n    const plainQuery: FilledMangoQuery<RxDocType> = {\r\n        selector: {\r\n            _deleted: {\r\n                $eq: false\r\n            }\r\n        } as any,\r\n        limit: batchSize,\r\n        sort: [{ [primaryPath]: 'asc' } as any],\r\n        skip: 0\r\n    };\r\n\r\n    /**\r\n     * In RxDB v15 we removed statics.prepareQuery()\r\n     * But to be downwards compatible, still use that\r\n     * when migrating from an old storage.\r\n     * TODO remove this in the next major version. v16.\r\n     */\r\n    let preparedQuery: PreparedQuery<RxDocType>;\r\n    if (oldStorage.statics && oldStorage.statics.prepareQuery) {\r\n        preparedQuery = oldStorage.statics.prepareQuery(\r\n            schema,\r\n            plainQuery\r\n        );\r\n    } else {\r\n        preparedQuery = prepareQuery(\r\n            schema,\r\n            plainQuery\r\n        );\r\n    }\r\n\r\n    while (true) {\r\n        log('loop once');\r\n        /**\r\n         * Get a batch of documents\r\n         */\r\n        const queryResult = await oldStorageInstance.query(preparedQuery);\r\n        const docs = queryResult.documents;\r\n        if (docs.length === 0) {\r\n            /**\r\n             * No more documents to migrate\r\n             */\r\n            log('migration of collection done');\r\n            await oldStorageInstance.remove();\r\n            return;\r\n        }\r\n\r\n        const docsNonMutated = clone(docs);\r\n\r\n        /**\r\n         * Get attachments\r\n         * if defined in the schema.\r\n         */\r\n        if (schema.attachments) {\r\n            await Promise.all(\r\n                docs.map(async (doc: any) => {\r\n                    const docId: string = (doc as any)[primaryPath];\r\n                    await Promise.all(\r\n                        Object.entries(doc._attachments).map(async ([attachmentId, attachmentMeta]) => {\r\n                            const attachmentData = await oldStorageInstance.getAttachmentData(\r\n                                docId,\r\n                                attachmentId,\r\n                                (attachmentMeta as any).digest\r\n                            );\r\n                            const attachmentDataString = await blobToBase64String(attachmentData);\r\n                            (doc as any)._attachments[attachmentId] = {\r\n                                data: attachmentDataString,\r\n                                digest: (attachmentMeta as any).digest,\r\n                                length: (attachmentMeta as any).length,\r\n                                type: (attachmentMeta as any).type\r\n                            }\r\n                        })\r\n                    );\r\n                })\r\n            );\r\n            log('got attachments');\r\n        }\r\n\r\n        /**\r\n         * Insert the documents to the new storage\r\n         */\r\n        const insertToNewWriteRows: BulkWriteRow<any>[] = docs.map((document: any) => {\r\n            return { document };\r\n        });\r\n        const writeToNewResult: RxStorageBulkWriteResponse<any> = await collection.storageInstance.bulkWrite(\r\n            insertToNewWriteRows,\r\n            'migrate-storage'\r\n        );\r\n        log('written batch to new storage');\r\n\r\n        // TODO we should throw on non-conflict errors here.\r\n        // if (Object.keys(writeToNewResult.error).length > 0) {\r\n        //     throw new Error('could not write to new storage');\r\n        // }\r\n\r\n        /**\r\n         * Remove the docs from the old storage\r\n         */\r\n        const writeToOldRows = docs.map((_doc: any, idx: number) => {\r\n            const previous = docsNonMutated[idx];\r\n            if (!previous._meta) {\r\n                previous._meta = {\r\n                    lwt: new Date().getTime()\r\n                };\r\n            }\r\n\r\n            const newDoc: typeof previous = clone(previous);\r\n            newDoc._deleted = true;\r\n            if (!newDoc._meta) {\r\n                newDoc._meta = {\r\n                    lwt: new Date().getTime()\r\n                };\r\n            }\r\n            newDoc._meta.lwt = new Date().getTime() + 1;\r\n            newDoc._rev = createRevision(\r\n                oldDatabaseInstanceToken,\r\n                previous\r\n            );\r\n\r\n            return {\r\n                previous,\r\n                document: newDoc,\r\n            }\r\n        });\r\n        try {\r\n            const writeToOldResult = await oldStorageInstance.bulkWrite(\r\n                writeToOldRows,\r\n                'migrate-between-rxdb-versions'\r\n            );\r\n            if (Object.keys(writeToOldResult.error).length > 0) {\r\n                console.dir({\r\n                    writeToOldRows,\r\n                    errors: writeToOldResult.error\r\n                });\r\n                throw new Error('got error while deleting migrated documents on the old storage');\r\n            }\r\n        } catch (err) {\r\n            log('could not delete on old instance');\r\n            console.dir(err);\r\n            throw err;\r\n        }\r\n        log('deleted batch on old storage');\r\n        await oldStorageInstance.cleanup(0)\r\n            .catch(() => {\r\n                /**\r\n                 * Migration from RxDB v14 to v15 had problem running the cleanup()\r\n                 * on the old storage because the indexing structure changed.\r\n                 * Because the periodic cleanup during migration\r\n                 * is an optional step, we just log instead of throwing an error.\r\n                 * @link https://github.com/pubkey/rxdb/issues/5565\r\n                 * \r\n                 * TODO remove this in the next major version\r\n                 */\r\n                log('oldStorageInstance.cleanup(0) has thrown');\r\n            });\r\n\r\n        // run the handler if provided\r\n        if (afterMigrateBatch) {\r\n            await afterMigrateBatch({\r\n                databaseName: collection.database.name,\r\n                collectionName: collection.name,\r\n                oldDatabaseName,\r\n                insertToNewWriteRows,\r\n                writeToNewResult\r\n            });\r\n        }\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n"],"mappings":"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","ignoreList":[]}