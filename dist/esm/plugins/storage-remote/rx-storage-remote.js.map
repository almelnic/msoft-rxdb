{"version":3,"file":"rx-storage-remote.js","names":["firstValueFrom","filter","Subject","RXDB_VERSION","randomCouchString","closeMessageChannel","getMessageChannel","RxStorageRemote","settings","name","rxdbVersion","seed","lastRequestId","mode","messageChannelIfOneMode","_proto","prototype","getRequestId","newId","createStorageInstance","params","connectionId","cacheKeys","push","collectionName","databaseName","messageChannel","requestId","waitForOkPromise","messages$","pipe","msg","answerTo","send","method","waitForOkResult","error","Error","JSON","stringify","RxStorageInstanceRemote","schema","options","customRequest","data","messageChannelCreator","waitForAnswerPromise","response","close","return","getMessageReturn","parse","storage","internals","changes$","conflicts$","subs","subscribe","next","_proto2","requestRemote","methodName","responsePromise","message","bulkWrite","documentWrites","context","findDocumentsById","ids","deleted","query","preparedQuery","count","getAttachmentData","documentId","attachmentId","digest","getChangedDocumentsSince","limit","checkpoint","changeStream","asObservable","cleanup","minDeletedTime","closed","forEach","sub","unsubscribe","complete","remove","conflictResultionTasks","resolveConflictResultionTask","taskSolution","getRxStorageRemote","withDefaults","Object","assign"],"sources":["../../../../src/plugins/storage-remote/rx-storage-remote.ts"],"sourcesContent":["import {\r\n    firstValueFrom,\r\n    filter,\r\n    Observable,\r\n    Subject,\r\n    Subscription\r\n} from 'rxjs';\r\nimport type {\r\n    BulkWriteRow,\r\n    EventBulk,\r\n    RxConflictResultionTask,\r\n    RxConflictResultionTaskSolution,\r\n    RxDocumentData,\r\n    RxJsonSchema,\r\n    RxStorage,\r\n    RxStorageBulkWriteResponse,\r\n    RxStorageChangeEvent,\r\n    RxStorageCountResult,\r\n    RxStorageInstance,\r\n    RxStorageInstanceCreationParams,\r\n    RxStorageQueryResult\r\n} from '../../types/index.d.ts';\r\nimport {\r\n    RXDB_VERSION,\r\n    randomCouchString\r\n} from '../../plugins/utils/index.ts';\r\nimport type {\r\n    MessageFromRemote,\r\n    MessageToRemote,\r\n    RemoteMessageChannel,\r\n    RxStorageRemoteInternals,\r\n    RxStorageRemoteSettings\r\n} from './storage-remote-types.ts';\r\nimport { closeMessageChannel, getMessageChannel } from './message-channel-cache.ts';\r\nimport { ensureRxStorageInstanceParamsAreCorrect } from '../../rx-storage-helper.ts';\r\n\r\n\r\nexport class RxStorageRemote implements RxStorage<RxStorageRemoteInternals, any> {\r\n    public readonly name: string = 'remote';\r\n    public readonly rxdbVersion = RXDB_VERSION;\r\n\r\n    private seed: string = randomCouchString(10);\r\n    private lastRequestId: number = 0;\r\n    public messageChannelIfOneMode?: Promise<RemoteMessageChannel>;\r\n    constructor(\r\n        public readonly settings: RxStorageRemoteSettings\r\n    ) {\r\n        if (settings.mode === 'one') {\r\n            this.messageChannelIfOneMode = getMessageChannel(\r\n                settings,\r\n                [],\r\n                true\r\n            );\r\n        }\r\n    }\r\n\r\n    public getRequestId() {\r\n        const newId = this.lastRequestId++;\r\n        return this.seed + '|' + newId;\r\n    }\r\n\r\n    async createStorageInstance<RxDocType>(\r\n        params: RxStorageInstanceCreationParams<RxDocType, any>\r\n    ): Promise<RxStorageInstanceRemote<RxDocType>> {\r\n        const connectionId = 'c|' + this.getRequestId();\r\n\r\n        const cacheKeys: string[] = [\r\n            'mode-' + this.settings.mode\r\n        ];\r\n        switch (this.settings.mode) {\r\n            case 'collection':\r\n                cacheKeys.push('collection-' + params.collectionName);\r\n            // eslint-disable-next-line no-fallthrough\r\n            case 'database':\r\n                cacheKeys.push('database-' + params.databaseName);\r\n            // eslint-disable-next-line no-fallthrough\r\n            case 'storage':\r\n                cacheKeys.push('seed-' + this.seed);\r\n        }\r\n        const messageChannel = await (this.messageChannelIfOneMode ?\r\n            this.messageChannelIfOneMode :\r\n            getMessageChannel(\r\n                this.settings,\r\n                cacheKeys\r\n            )\r\n        );\r\n\r\n        const requestId = this.getRequestId();\r\n        const waitForOkPromise = firstValueFrom(messageChannel.messages$.pipe(\r\n            filter(msg => msg.answerTo === requestId)\r\n        ));\r\n        messageChannel.send({\r\n            connectionId,\r\n            method: 'create',\r\n            requestId,\r\n            params\r\n        });\r\n\r\n        const waitForOkResult = await waitForOkPromise;\r\n        if (waitForOkResult.error) {\r\n            await closeMessageChannel(messageChannel);\r\n            throw new Error('could not create instance ' + JSON.stringify(waitForOkResult.error));\r\n        }\r\n\r\n        return new RxStorageInstanceRemote(\r\n            this,\r\n            params.databaseName,\r\n            params.collectionName,\r\n            params.schema,\r\n            {\r\n                params,\r\n                connectionId,\r\n                messageChannel\r\n            },\r\n            params.options\r\n        );\r\n    }\r\n\r\n    async customRequest<In, Out>(data: In): Promise<Out> {\r\n        const messageChannel = await this.settings.messageChannelCreator();\r\n        const requestId = this.getRequestId();\r\n        const connectionId = 'custom|request|' + requestId;\r\n        const waitForAnswerPromise = firstValueFrom(messageChannel.messages$.pipe(\r\n            filter(msg => msg.answerTo === requestId)\r\n        ));\r\n        messageChannel.send({\r\n            connectionId,\r\n            method: 'custom',\r\n            requestId,\r\n            params: data\r\n        });\r\n        const response = await waitForAnswerPromise;\r\n        if (response.error) {\r\n            await messageChannel.close();\r\n            throw new Error('could not run customRequest(): ' + JSON.stringify({\r\n                data,\r\n                error: response.error\r\n            }));\r\n        } else {\r\n            await messageChannel.close();\r\n            return response.return;\r\n        }\r\n\r\n    }\r\n}\r\n\r\n/**\r\n * Because postMessage() can be very slow on complex objects,\r\n * and some RxStorage implementations do need a JSON-string internally\r\n * anyway, it is allowed to transfer a string instead of an object\r\n * which must then be JSON.parse()-ed before RxDB can use it.\r\n * @link https://surma.dev/things/is-postmessage-slow/\r\n */\r\nfunction getMessageReturn(\r\n    msg: MessageFromRemote\r\n) {\r\n    if (msg.method === 'getAttachmentData') {\r\n        return msg.return;\r\n    } else {\r\n        if (typeof msg.return === 'string') {\r\n            return JSON.parse(msg.return);\r\n        } else {\r\n            return msg.return;\r\n        }\r\n    }\r\n}\r\n\r\nexport class RxStorageInstanceRemote<RxDocType> implements RxStorageInstance<RxDocType, RxStorageRemoteInternals, any, any> {\r\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, any>> = new Subject();\r\n    private conflicts$: Subject<RxConflictResultionTask<RxDocType>> = new Subject();\r\n    private subs: Subscription[] = [];\r\n\r\n    private closed?: Promise<void>;\r\n    messages$: Observable<MessageFromRemote>;\r\n\r\n    constructor(\r\n        public readonly storage: RxStorageRemote,\r\n        public readonly databaseName: string,\r\n        public readonly collectionName: string,\r\n        public readonly schema: Readonly<RxJsonSchema<RxDocumentData<RxDocType>>>,\r\n        public readonly internals: RxStorageRemoteInternals,\r\n        public readonly options: Readonly<any>\r\n    ) {\r\n        this.messages$ = this.internals.messageChannel.messages$.pipe(\r\n            filter(msg => msg.connectionId === this.internals.connectionId)\r\n        );\r\n        this.subs.push(\r\n            this.messages$.subscribe(msg => {\r\n                if (msg.method === 'changeStream') {\r\n                    this.changes$.next(getMessageReturn(msg));\r\n                }\r\n                if (msg.method === 'conflictResultionTasks') {\r\n                    this.conflicts$.next(msg.return);\r\n                }\r\n            })\r\n        );\r\n    }\r\n\r\n    private async requestRemote(\r\n        methodName: keyof RxStorageInstance<any, any, any>,\r\n        params: any\r\n    ) {\r\n        const requestId = this.storage.getRequestId();\r\n        const responsePromise = firstValueFrom(\r\n            this.messages$.pipe(\r\n                filter(msg => msg.answerTo === requestId)\r\n            )\r\n        );\r\n        const message: MessageToRemote = {\r\n            connectionId: this.internals.connectionId,\r\n            requestId,\r\n            method: methodName,\r\n            params\r\n        };\r\n        this.internals.messageChannel.send(message);\r\n        const response = await responsePromise;\r\n        if (response.error) {\r\n            throw new Error('could not requestRemote: ' + JSON.stringify({\r\n                methodName,\r\n                params,\r\n                error: response.error\r\n            }, null, 4));\r\n        } else {\r\n            return getMessageReturn(response);\r\n        }\r\n    }\r\n    bulkWrite(\r\n        documentWrites: BulkWriteRow<RxDocType>[],\r\n        context: string\r\n    ): Promise<RxStorageBulkWriteResponse<RxDocType>> {\r\n        return this.requestRemote('bulkWrite', [documentWrites, context]);\r\n    }\r\n    findDocumentsById(ids: string[], deleted: boolean): Promise<RxDocumentData<RxDocType>[]> {\r\n        return this.requestRemote('findDocumentsById', [ids, deleted]);\r\n    }\r\n    query(preparedQuery: any): Promise<RxStorageQueryResult<RxDocType>> {\r\n        return this.requestRemote('query', [preparedQuery]);\r\n    }\r\n    count(preparedQuery: any): Promise<RxStorageCountResult> {\r\n        return this.requestRemote('count', [preparedQuery]);\r\n    }\r\n    getAttachmentData(documentId: string, attachmentId: string, digest: string): Promise<string> {\r\n        return this.requestRemote('getAttachmentData', [documentId, attachmentId, digest]);\r\n    }\r\n    getChangedDocumentsSince(\r\n        limit: number,\r\n        checkpoint?: any\r\n    ): Promise<\r\n        {\r\n            documents: RxDocumentData<RxDocType>[];\r\n            checkpoint: any;\r\n        }> {\r\n        return this.requestRemote('getChangedDocumentsSince', [limit, checkpoint]);\r\n    }\r\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, any>> {\r\n        return this.changes$.asObservable();\r\n    }\r\n    cleanup(minDeletedTime: number): Promise<boolean> {\r\n        return this.requestRemote('cleanup', [minDeletedTime]);\r\n    }\r\n    async close(): Promise<void> {\r\n        if (this.closed) {\r\n            return this.closed;\r\n        }\r\n        this.closed = (async () => {\r\n            this.subs.forEach(sub => sub.unsubscribe());\r\n            this.changes$.complete();\r\n            await this.requestRemote('close', []);\r\n            await closeMessageChannel(this.internals.messageChannel);\r\n        })();\r\n        return this.closed;\r\n    }\r\n    async remove(): Promise<void> {\r\n        if (this.closed) {\r\n            throw new Error('already closed');\r\n        }\r\n        this.closed = (async () => {\r\n            await this.requestRemote('remove', []);\r\n            await closeMessageChannel(this.internals.messageChannel);\r\n        })();\r\n        return this.closed;\r\n    }\r\n    conflictResultionTasks(): Observable<RxConflictResultionTask<RxDocType>> {\r\n        return this.conflicts$;\r\n    }\r\n    async resolveConflictResultionTask(taskSolution: RxConflictResultionTaskSolution<RxDocType>): Promise<void> {\r\n        await this.requestRemote('resolveConflictResultionTask', [taskSolution]);\r\n    }\r\n}\r\n\r\nexport function getRxStorageRemote(settings: RxStorageRemoteSettings): RxStorageRemote {\r\n    const withDefaults = Object.assign({\r\n        mode: 'storage'\r\n    }, settings);\r\n    return new RxStorageRemote(withDefaults);\r\n}\r\n"],"mappings":"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","ignoreList":[]}