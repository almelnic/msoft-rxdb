{"version":3,"file":"graphql-websocket.js","names":["createClient","getFromMapOrCreate","getFromMapOrThrow","ws","WebSocket","IsomorphicWebSocket","GRAPHQL_WEBSOCKET_BY_URL","Map","getGraphQLWebSocket","url","headers","has","wsClient","shouldRetry","webSocketImpl","connectionParams","undefined","socket","refCount","value","removeGraphQLWebSocketRef","obj","delete","dispose"],"sources":["../../../../src/plugins/replication-graphql/graphql-websocket.ts"],"sourcesContent":["import { Client, createClient } from 'graphql-ws';\r\nimport { getFromMapOrCreate, getFromMapOrThrow } from '../../plugins/utils/index.ts';\r\nimport ws from 'isomorphic-ws';\r\n\r\nconst { WebSocket: IsomorphicWebSocket } = ws;\r\n\r\nexport type WebsocketWithRefCount = {\r\n    url: string;\r\n    socket: Client;\r\n    refCount: number;\r\n};\r\n\r\nexport const GRAPHQL_WEBSOCKET_BY_URL: Map<string, WebsocketWithRefCount> = new Map();\r\n\r\n\r\nexport function getGraphQLWebSocket(\r\n    url: string,\r\n    headers?: { [k: string]: string; }\r\n): Client {\r\n\r\n    const has = getFromMapOrCreate(\r\n        GRAPHQL_WEBSOCKET_BY_URL,\r\n        url,\r\n        () => {\r\n            const wsClient = createClient({\r\n                url,\r\n                shouldRetry: () => true,\r\n                webSocketImpl: IsomorphicWebSocket,\r\n                connectionParams: headers ? { headers } : undefined,\r\n            });\r\n            return {\r\n                url,\r\n                socket: wsClient,\r\n                refCount: 1\r\n            };\r\n        },\r\n        (value) => {\r\n            value.refCount = value.refCount + 1;\r\n        }\r\n    );\r\n    return has.socket;\r\n}\r\n\r\n\r\nexport function removeGraphQLWebSocketRef(\r\n    url: string\r\n) {\r\n    const obj = getFromMapOrThrow(GRAPHQL_WEBSOCKET_BY_URL, url);\r\n    obj.refCount = obj.refCount - 1;\r\n    if (obj.refCount === 0) {\r\n        GRAPHQL_WEBSOCKET_BY_URL.delete(url);\r\n        obj.socket.dispose();\r\n    }\r\n}\r\n"],"mappings":"AAAA,SAAiBA,YAAY,QAAQ,YAAY;AACjD,SAASC,kBAAkB,EAAEC,iBAAiB,QAAQ,8BAA8B;AACpF,OAAOC,EAAE,MAAM,eAAe;AAE9B,IAAM;EAAEC,SAAS,EAAEC;AAAoB,CAAC,GAAGF,EAAE;AAQ7C,OAAO,IAAMG,wBAA4D,GAAG,IAAIC,GAAG,CAAC,CAAC;AAGrF,OAAO,SAASC,mBAAmBA,CAC/BC,GAAW,EACXC,OAAkC,EAC5B;EAEN,IAAMC,GAAG,GAAGV,kBAAkB,CAC1BK,wBAAwB,EACxBG,GAAG,EACH,MAAM;IACF,IAAMG,QAAQ,GAAGZ,YAAY,CAAC;MAC1BS,GAAG;MACHI,WAAW,EAAEA,CAAA,KAAM,IAAI;MACvBC,aAAa,EAAET,mBAAmB;MAClCU,gBAAgB,EAAEL,OAAO,GAAG;QAAEA;MAAQ,CAAC,GAAGM;IAC9C,CAAC,CAAC;IACF,OAAO;MACHP,GAAG;MACHQ,MAAM,EAAEL,QAAQ;MAChBM,QAAQ,EAAE;IACd,CAAC;EACL,CAAC,EACAC,KAAK,IAAK;IACPA,KAAK,CAACD,QAAQ,GAAGC,KAAK,CAACD,QAAQ,GAAG,CAAC;EACvC,CACJ,CAAC;EACD,OAAOP,GAAG,CAACM,MAAM;AACrB;AAGA,OAAO,SAASG,yBAAyBA,CACrCX,GAAW,EACb;EACE,IAAMY,GAAG,GAAGnB,iBAAiB,CAACI,wBAAwB,EAAEG,GAAG,CAAC;EAC5DY,GAAG,CAACH,QAAQ,GAAGG,GAAG,CAACH,QAAQ,GAAG,CAAC;EAC/B,IAAIG,GAAG,CAACH,QAAQ,KAAK,CAAC,EAAE;IACpBZ,wBAAwB,CAACgB,MAAM,CAACb,GAAG,CAAC;IACpCY,GAAG,CAACJ,MAAM,CAACM,OAAO,CAAC,CAAC;EACxB;AACJ","ignoreList":[]}