{"version":3,"file":"rx-schema-helper.js","names":["newRxError","appendToArray","ensureNotFalsy","flatClone","getProperty","isMaybeReadonlyArray","REGEX_ALL_DOTS","RX_META_LWT_MINIMUM","sortObject","trimDots","getPseudoSchemaForVersion","version","primaryKey","pseudoSchema","fillWithDefaultSettings","type","properties","maxLength","indexes","required","getSchemaByObjectPath","rxJsonSchema","path","usePath","replace","ret","fillPrimaryKey","primaryPath","jsonSchema","documentData","newPrimary","getComposedPrimaryKeyOfDocumentData","existingPrimary","args","schema","getPrimaryFieldOfPrimaryKey","key","getLengthOfPrimaryKey","schemaPart","compositePrimary","fields","map","field","value","join","separator","normalizeRxJsonSchema","normalizedSchema","getDefaultIndex","schemaObj","additionalProperties","Object","prototype","hasOwnProperty","call","keyCompression","slice","encrypted","_rev","minLength","_attachments","_deleted","_meta","RX_META_SCHEMA","push","finalFields","getFinalFields","filter","includes","elem","pos","arr","indexOf","useIndexes","index","arIndex","unshift","length","internalIndexes","idx","hasIndex","Set","indexStr","has","add","lwt","minimum","maximum","multipleOf","keys","final","forEach","fillObjectWithDefaults","rxSchema","obj","defaultKeys","defaultValues","i","DEFAULT_CHECKPOINT_SCHEMA","id"],"sources":["../../src/rx-schema-helper.ts"],"sourcesContent":["import { newRxError } from './rx-error.ts';\r\nimport type {\r\n    CompositePrimaryKey,\r\n    DeepReadonly,\r\n    JsonSchema,\r\n    PrimaryKey,\r\n    RxDocumentData,\r\n    RxJsonSchema,\r\n    RxStorageDefaultCheckpoint,\r\n    StringKeys\r\n} from './types/index.d.ts';\r\nimport {\r\n    appendToArray,\r\n    ensureNotFalsy,\r\n    flatClone,\r\n    getProperty,\r\n    isMaybeReadonlyArray,\r\n    REGEX_ALL_DOTS,\r\n    RX_META_LWT_MINIMUM,\r\n    sortObject,\r\n    trimDots\r\n} from './plugins/utils/index.ts';\r\nimport type { RxSchema } from './rx-schema.ts';\r\n\r\n/**\r\n * Helper function to create a valid RxJsonSchema\r\n * with a given version.\r\n */\r\nexport function getPseudoSchemaForVersion<T = any>(\r\n    version: number,\r\n    primaryKey: StringKeys<T>\r\n): RxJsonSchema<RxDocumentData<T>> {\r\n    const pseudoSchema: RxJsonSchema<RxDocumentData<T>> = fillWithDefaultSettings({\r\n        version,\r\n        type: 'object',\r\n        primaryKey: primaryKey as any,\r\n        properties: {\r\n            [primaryKey]: {\r\n                type: 'string',\r\n                maxLength: 100\r\n            }\r\n        } as any,\r\n        indexes: [\r\n            [primaryKey]\r\n        ],\r\n        required: [primaryKey]\r\n    });\r\n    return pseudoSchema;\r\n}\r\n\r\n/**\r\n * Returns the sub-schema for a given path\r\n */\r\nexport function getSchemaByObjectPath<T = any>(\r\n    rxJsonSchema: RxJsonSchema<T>,\r\n    path: keyof T | string\r\n): JsonSchema {\r\n    let usePath: string = path as string;\r\n    usePath = usePath.replace(REGEX_ALL_DOTS, '.properties.');\r\n    usePath = 'properties.' + usePath;\r\n    usePath = trimDots(usePath);\r\n\r\n    const ret = getProperty(rxJsonSchema, usePath);\r\n    return ret;\r\n}\r\n\r\nexport function fillPrimaryKey<T>(\r\n    primaryPath: keyof T,\r\n    jsonSchema: RxJsonSchema<T>,\r\n    documentData: RxDocumentData<T>\r\n): RxDocumentData<T> {\r\n    // optimization shortcut.\r\n    if (typeof jsonSchema.primaryKey === 'string') {\r\n        return documentData;\r\n    }\r\n\r\n    const newPrimary = getComposedPrimaryKeyOfDocumentData<T>(\r\n        jsonSchema,\r\n        documentData\r\n    );\r\n    const existingPrimary: string | undefined = documentData[primaryPath] as any;\r\n    if (\r\n        existingPrimary &&\r\n        existingPrimary !== newPrimary\r\n    ) {\r\n        throw newRxError(\r\n            'DOC19',\r\n            {\r\n                args: {\r\n                    documentData,\r\n                    existingPrimary,\r\n                    newPrimary,\r\n                },\r\n                schema: jsonSchema\r\n            });\r\n    }\r\n\r\n    (documentData as any)[primaryPath] = newPrimary;\r\n    return documentData;\r\n}\r\n\r\nexport function getPrimaryFieldOfPrimaryKey<RxDocType>(\r\n    primaryKey: PrimaryKey<RxDocType>\r\n): StringKeys<RxDocType> {\r\n    if (typeof primaryKey === 'string') {\r\n        return primaryKey as any;\r\n    } else {\r\n        return (primaryKey as CompositePrimaryKey<RxDocType>).key;\r\n    }\r\n}\r\n\r\nexport function getLengthOfPrimaryKey<RxDocType>(\r\n    schema: RxJsonSchema<RxDocumentData<RxDocType>>\r\n): number {\r\n    const primaryPath = getPrimaryFieldOfPrimaryKey(schema.primaryKey);\r\n    const schemaPart = getSchemaByObjectPath(schema, primaryPath);\r\n    return ensureNotFalsy(schemaPart.maxLength);\r\n}\r\n\r\n/**\r\n * Returns the composed primaryKey of a document by its data.\r\n */\r\nexport function getComposedPrimaryKeyOfDocumentData<RxDocType>(\r\n    jsonSchema: RxJsonSchema<RxDocType> | RxJsonSchema<RxDocumentData<RxDocType>>,\r\n    documentData: Partial<RxDocType>\r\n): string {\r\n    if (typeof jsonSchema.primaryKey === 'string') {\r\n        return (documentData as any)[jsonSchema.primaryKey];\r\n    }\r\n\r\n    const compositePrimary: CompositePrimaryKey<RxDocType> = jsonSchema.primaryKey as any;\r\n    return compositePrimary.fields.map(field => {\r\n        const value = getProperty(documentData as any, field as string);\r\n        if (typeof value === 'undefined') {\r\n            throw newRxError('DOC18', { args: { field, documentData } });\r\n        }\r\n        return value;\r\n    }).join(compositePrimary.separator);\r\n}\r\n\r\n\r\n/**\r\n * Normalize the RxJsonSchema.\r\n * We need this to ensure everything is set up properly\r\n * and we have the same hash on schemas that represent the same value but\r\n * have different json.\r\n *\r\n * - Orders the schemas attributes by alphabetical order\r\n * - Adds the primaryKey to all indexes that do not contain the primaryKey\r\n * - We need this for deterministic sort order on all queries, which is required for event-reduce to work.\r\n *\r\n * @return RxJsonSchema - ordered and filled\r\n */\r\nexport function normalizeRxJsonSchema<T>(jsonSchema: RxJsonSchema<T>): RxJsonSchema<T> {\r\n    const normalizedSchema: RxJsonSchema<T> = sortObject(jsonSchema, true);\r\n    return normalizedSchema;\r\n}\r\n\r\n/**\r\n * If the schema does not specify any index,\r\n * we add this index so we at least can run RxQuery()\r\n * and only select non-deleted fields.\r\n */\r\nexport function getDefaultIndex(primaryPath: string) {\r\n    return ['_deleted', primaryPath];\r\n}\r\n\r\n/**\r\n * fills the schema-json with default-settings\r\n * @return cloned schemaObj\r\n */\r\nexport function fillWithDefaultSettings<T = any>(\r\n    schemaObj: RxJsonSchema<T>\r\n): RxJsonSchema<RxDocumentData<T>> {\r\n    schemaObj = flatClone(schemaObj);\r\n    const primaryPath: string = getPrimaryFieldOfPrimaryKey(schemaObj.primaryKey);\r\n    schemaObj.properties = flatClone(schemaObj.properties);\r\n\r\n    // additionalProperties is always false\r\n    schemaObj.additionalProperties = false;\r\n\r\n    // fill with key-compression-state ()\r\n    if (!Object.prototype.hasOwnProperty.call(schemaObj, 'keyCompression')) {\r\n        schemaObj.keyCompression = false;\r\n    }\r\n\r\n    // indexes must be array\r\n    schemaObj.indexes = schemaObj.indexes ? schemaObj.indexes.slice(0) : [];\r\n\r\n    // required must be array\r\n    schemaObj.required = schemaObj.required ? schemaObj.required.slice(0) : [];\r\n\r\n    // encrypted must be array\r\n    schemaObj.encrypted = schemaObj.encrypted ? schemaObj.encrypted.slice(0) : [];\r\n\r\n    // add _rev\r\n    (schemaObj.properties as any)._rev = {\r\n        type: 'string',\r\n        minLength: 1\r\n    };\r\n\r\n    // add attachments\r\n    (schemaObj.properties as any)._attachments = {\r\n        type: 'object'\r\n    };\r\n\r\n    // add deleted flag\r\n    (schemaObj.properties as any)._deleted = {\r\n        type: 'boolean'\r\n    };\r\n\r\n    // add meta property\r\n    (schemaObj.properties as any)._meta = RX_META_SCHEMA;\r\n\r\n    /**\r\n     * meta fields are all required\r\n     */\r\n    schemaObj.required = schemaObj.required ? schemaObj.required.slice(0) : [];\r\n    (schemaObj.required as string[]).push('_deleted');\r\n    (schemaObj.required as string[]).push('_rev');\r\n    (schemaObj.required as string[]).push('_meta');\r\n    (schemaObj.required as string[]).push('_attachments');\r\n\r\n    // final fields are always required\r\n    const finalFields = getFinalFields(schemaObj);\r\n    appendToArray(schemaObj.required as any, finalFields);\r\n    schemaObj.required = schemaObj.required\r\n        .filter((field: string) => !field.includes('.'))\r\n        .filter((elem: any, pos: any, arr: any) => arr.indexOf(elem) === pos); // unique;\r\n\r\n    // version is 0 by default\r\n    schemaObj.version = schemaObj.version || 0;\r\n\r\n    const useIndexes: string[][] = schemaObj.indexes.map(index => {\r\n        const arIndex = isMaybeReadonlyArray(index) ? index.slice(0) : [index];\r\n        /**\r\n         * Append primary key to indexes that do not contain the primaryKey.\r\n         * All indexes must have the primaryKey to ensure a deterministic sort order.\r\n         */\r\n        if (!arIndex.includes(primaryPath)) {\r\n            arIndex.push(primaryPath);\r\n        }\r\n\r\n        // add _deleted flag to all indexes so we can query only non-deleted fields\r\n        // in RxDB itself\r\n        if (arIndex[0] !== '_deleted') {\r\n            arIndex.unshift('_deleted');\r\n        }\r\n\r\n        return arIndex;\r\n    });\r\n\r\n    if (useIndexes.length === 0) {\r\n        useIndexes.push(getDefaultIndex(primaryPath));\r\n    }\r\n\r\n    // we need this index for the getChangedDocumentsSince() method\r\n    useIndexes.push(['_meta.lwt', primaryPath]);\r\n\r\n    // also add the internalIndexes\r\n    if (schemaObj.internalIndexes) {\r\n        schemaObj.internalIndexes.map(idx => {\r\n            useIndexes.push(idx);\r\n        });\r\n    }\r\n\r\n    // make indexes unique\r\n    const hasIndex = new Set<string>();\r\n    useIndexes.filter(index => {\r\n        const indexStr = index.join(',');\r\n        if (hasIndex.has(indexStr)) {\r\n            return false;\r\n        } else {\r\n            hasIndex.add(indexStr);\r\n            return true;\r\n        }\r\n    });\r\n\r\n    schemaObj.indexes = useIndexes;\r\n\r\n    return schemaObj as any;\r\n}\r\n\r\n\r\nexport const RX_META_SCHEMA: JsonSchema = {\r\n    type: 'object',\r\n    properties: {\r\n        /**\r\n         * The last-write time.\r\n         * Unix time in milliseconds.\r\n         */\r\n        lwt: {\r\n            type: 'number',\r\n            /**\r\n             * We use 1 as minimum so that the value is never falsy.\r\n             */\r\n            minimum: RX_META_LWT_MINIMUM,\r\n            maximum: 1000000000000000,\r\n            multipleOf: 0.01\r\n        }\r\n    },\r\n    /**\r\n     * Additional properties are allowed\r\n     * and can be used by plugins to set various flags.\r\n     */\r\n    additionalProperties: true as any,\r\n    required: [\r\n        'lwt'\r\n    ]\r\n};\r\n\r\n\r\n/**\r\n * returns the final-fields of the schema\r\n * @return field-names of the final-fields\r\n */\r\nexport function getFinalFields<T = any>(\r\n    jsonSchema: RxJsonSchema<T>\r\n): string[] {\r\n    const ret = Object.keys(jsonSchema.properties)\r\n        .filter(key => (jsonSchema as any).properties[key].final);\r\n\r\n    // primary is also final\r\n    const primaryPath = getPrimaryFieldOfPrimaryKey(jsonSchema.primaryKey);\r\n    ret.push(primaryPath);\r\n\r\n    // fields of composite primary are final\r\n    if (typeof jsonSchema.primaryKey !== 'string') {\r\n        (jsonSchema.primaryKey as CompositePrimaryKey<T>).fields\r\n            .forEach(field => ret.push(field as string));\r\n    }\r\n\r\n    return ret;\r\n}\r\n\r\n/**\r\n * fills all unset fields with default-values if set\r\n * @hotPath\r\n */\r\nexport function fillObjectWithDefaults(rxSchema: RxSchema<any>, obj: any): any {\r\n    const defaultKeys = Object.keys(rxSchema.defaultValues);\r\n    for (let i = 0; i < defaultKeys.length; ++i) {\r\n        const key = defaultKeys[i];\r\n        if (!Object.prototype.hasOwnProperty.call(obj, key) || typeof obj[key] === 'undefined') {\r\n            obj[key] = rxSchema.defaultValues[key];\r\n        }\r\n    }\r\n    return obj;\r\n}\r\n\r\nexport const DEFAULT_CHECKPOINT_SCHEMA: DeepReadonly<JsonSchema<RxStorageDefaultCheckpoint>> = {\r\n    type: 'object',\r\n    properties: {\r\n        id: {\r\n            type: 'string'\r\n        },\r\n        lwt: {\r\n            type: 'number'\r\n        }\r\n    },\r\n    required: [\r\n        'id',\r\n        'lwt'\r\n    ],\r\n    additionalProperties: false\r\n} as const;\r\n"],"mappings":"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","ignoreList":[]}