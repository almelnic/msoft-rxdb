{"version":3,"file":"loki-save-queue.js","names":["_index","require","LokiSaveQueue","exports","lokiDatabase","databaseSettings","writesSinceLastRun","saveQueue","PROMISE_RESOLVE_VOID","saveQueueC","_proto","prototype","addWrite","run","adapter","then","requestIdlePromise","writeAmount","Promise","res","rej","saveDatabase","err","autosaveCallback","catch"],"sources":["../../../../src/plugins/storage-lokijs/loki-save-queue.ts"],"sourcesContent":["import type { LokiDatabaseSettings } from '../../types/index.d.ts';\r\nimport {\r\n    PROMISE_RESOLVE_VOID,\r\n    requestIdlePromise\r\n} from '../utils/index.ts';\r\n\r\n/**\r\n * The autosave feature of lokijs has strange behaviors\r\n * and often runs a save in critical moments when other\r\n * more important tasks are running.\r\n * So instead we use a custom save queue that ensures we\r\n * only run loki.saveDatabase() when nothing else is running.\r\n */\r\nexport class LokiSaveQueue {\r\n    public writesSinceLastRun: number = 0;\r\n\r\n    /**\r\n     * Ensures that we do not run multiple saves\r\n     * in parallel\r\n     */\r\n    public saveQueue: Promise<void> = PROMISE_RESOLVE_VOID;\r\n    // track amount of non-finished save calls in the queue.\r\n    public saveQueueC = 0;\r\n\r\n    constructor(\r\n        public readonly lokiDatabase: any,\r\n        public readonly databaseSettings: LokiDatabaseSettings\r\n    ) {\r\n\r\n    }\r\n\r\n    public addWrite() {\r\n        this.writesSinceLastRun = this.writesSinceLastRun + 1;\r\n        this.run();\r\n    }\r\n\r\n    public run() {\r\n        if (\r\n            // no persistence adapter given, so we do not need to save\r\n            !this.databaseSettings.adapter ||\r\n            // do not add more then two pending calls to the queue.\r\n            this.saveQueueC > 2\r\n\r\n        ) {\r\n            return this.saveQueue;\r\n        }\r\n\r\n        this.saveQueueC = this.saveQueueC + 1;\r\n        this.saveQueue = this.saveQueue\r\n            .then(async () => {\r\n                /**\r\n                 * Always wait until the JavaScript process is idle.\r\n                 * This ensures that CPU blocking writes are finished\r\n                 * before we proceed.\r\n                 */\r\n                await requestIdlePromise();\r\n\r\n                // no write happened since the last save call\r\n                if (this.writesSinceLastRun === 0) {\r\n                    return;\r\n                }\r\n\r\n                /**\r\n                 * Because LokiJS is a in-memory database,\r\n                 * we can just wait until the JavaScript process is idle\r\n                 * via requestIdlePromise(). Then we know that nothing important\r\n                 * is running at the moment.\r\n                 */\r\n                await requestIdlePromise().then(() => requestIdlePromise());\r\n\r\n                if (this.writesSinceLastRun === 0) {\r\n                    return;\r\n                }\r\n\r\n                const writeAmount = this.writesSinceLastRun;\r\n                this.writesSinceLastRun = 0;\r\n                return new Promise<void>((res, rej) => {\r\n                    this.lokiDatabase.saveDatabase((err: any) => {\r\n                        if (err) {\r\n                            this.writesSinceLastRun = this.writesSinceLastRun + writeAmount;\r\n                            rej(err);\r\n                        } else {\r\n                            if (this.databaseSettings.autosaveCallback) {\r\n                                this.databaseSettings.autosaveCallback();\r\n                            }\r\n                            res();\r\n                        }\r\n                    });\r\n                });\r\n            })\r\n            .catch(() => { })\r\n            .then(() => {\r\n                this.saveQueueC = this.saveQueueC - 1;\r\n            });\r\n        return this.saveQueue;\r\n    }\r\n}\r\n"],"mappings":";;;;;;AACA,IAAAA,MAAA,GAAAC,OAAA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AANA,IAOaC,aAAa,GAAAC,OAAA,CAAAD,aAAA;EAGtB;AACJ;AACA;AACA;;EAEI;;EAGA,SAAAA,cACoBE,YAAiB,EACjBC,gBAAsC,EACxD;IAAA,KAbKC,kBAAkB,GAAW,CAAC;IAAA,KAM9BC,SAAS,GAAkBC,2BAAoB;IAAA,KAE/CC,UAAU,GAAG,CAAC;IAAA,KAGDL,YAAiB,GAAjBA,YAAiB;IAAA,KACjBC,gBAAsC,GAAtCA,gBAAsC;EAG1D;EAAC,IAAAK,MAAA,GAAAR,aAAA,CAAAS,SAAA;EAAAD,MAAA,CAEME,QAAQ,GAAf,SAAOA,QAAQA,CAAA,EAAG;IACd,IAAI,CAACN,kBAAkB,GAAG,IAAI,CAACA,kBAAkB,GAAG,CAAC;IACrD,IAAI,CAACO,GAAG,CAAC,CAAC;EACd,CAAC;EAAAH,MAAA,CAEMG,GAAG,GAAV,SAAOA,GAAGA,CAAA,EAAG;IACT;IACI;IACA,CAAC,IAAI,CAACR,gBAAgB,CAACS,OAAO;IAC9B;IACA,IAAI,CAACL,UAAU,GAAG,CAAC,EAErB;MACE,OAAO,IAAI,CAACF,SAAS;IACzB;IAEA,IAAI,CAACE,UAAU,GAAG,IAAI,CAACA,UAAU,GAAG,CAAC;IACrC,IAAI,CAACF,SAAS,GAAG,IAAI,CAACA,SAAS,CAC1BQ,IAAI,CAAC,YAAY;MACd;AAChB;AACA;AACA;AACA;MACgB,MAAM,IAAAC,yBAAkB,EAAC,CAAC;;MAE1B;MACA,IAAI,IAAI,CAACV,kBAAkB,KAAK,CAAC,EAAE;QAC/B;MACJ;;MAEA;AAChB;AACA;AACA;AACA;AACA;MACgB,MAAM,IAAAU,yBAAkB,EAAC,CAAC,CAACD,IAAI,CAAC,MAAM,IAAAC,yBAAkB,EAAC,CAAC,CAAC;MAE3D,IAAI,IAAI,CAACV,kBAAkB,KAAK,CAAC,EAAE;QAC/B;MACJ;MAEA,IAAMW,WAAW,GAAG,IAAI,CAACX,kBAAkB;MAC3C,IAAI,CAACA,kBAAkB,GAAG,CAAC;MAC3B,OAAO,IAAIY,OAAO,CAAO,CAACC,GAAG,EAAEC,GAAG,KAAK;QACnC,IAAI,CAAChB,YAAY,CAACiB,YAAY,CAAEC,GAAQ,IAAK;UACzC,IAAIA,GAAG,EAAE;YACL,IAAI,CAAChB,kBAAkB,GAAG,IAAI,CAACA,kBAAkB,GAAGW,WAAW;YAC/DG,GAAG,CAACE,GAAG,CAAC;UACZ,CAAC,MAAM;YACH,IAAI,IAAI,CAACjB,gBAAgB,CAACkB,gBAAgB,EAAE;cACxC,IAAI,CAAClB,gBAAgB,CAACkB,gBAAgB,CAAC,CAAC;YAC5C;YACAJ,GAAG,CAAC,CAAC;UACT;QACJ,CAAC,CAAC;MACN,CAAC,CAAC;IACN,CAAC,CAAC,CACDK,KAAK,CAAC,MAAM,CAAE,CAAC,CAAC,CAChBT,IAAI,CAAC,MAAM;MACR,IAAI,CAACN,UAAU,GAAG,IAAI,CAACA,UAAU,GAAG,CAAC;IACzC,CAAC,CAAC;IACN,OAAO,IAAI,CAACF,SAAS;EACzB,CAAC;EAAA,OAAAL,aAAA;AAAA","ignoreList":[]}