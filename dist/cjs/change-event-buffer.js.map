{"version":3,"file":"change-event-buffer.js","names":["_operators","require","_index","ChangeEventBuffer","exports","collection","subs","counter","eventCounterMap","WeakMap","buffer","limit","tasks","Set","push","database","eventBulks$","pipe","filter","changeEventBulk","collectionName","name","bulk","first","events","isLocal","subscribe","eventBulk","add","_handleChangeEvents","size","requestIdlePromiseNoQueue","then","processTasks","_proto","prototype","Array","from","forEach","task","clear","counterBefore","length","slice","appendToArray","counterBase","index","event","set","getCounter","getBuffer","getArrayIndexByPointer","pointer","oldestEvent","oldestCounter","get","rest","getFrom","ret","currentIndex","nextEvent","runFrom","fn","Error","cE","reduceByLastOfDoc","changeEvents","docEventMap","changeEvent","documentId","Object","values","destroy","sub","unsubscribe","createChangeEventBuffer"],"sources":["../../src/change-event-buffer.ts"],"sourcesContent":["/**\r\n * a buffer-cache which holds the last X changeEvents of the collection\r\n */\r\nimport {\r\n    Subscription\r\n} from 'rxjs';\r\nimport { filter } from 'rxjs/operators';\r\nimport type {\r\n    RxChangeEvent,\r\n    RxCollection\r\n} from './types/index.d.ts';\r\nimport {\r\n    appendToArray,\r\n    requestIdlePromiseNoQueue\r\n} from './plugins/utils/index.ts';\r\n\r\n/**\r\n * This buffer rembemers previous change events\r\n * so that queries can use them on .exec()\r\n * to calculate the new result set via event-reduce instead\r\n * of running the query against the storage.\r\n */\r\nexport class ChangeEventBuffer<RxDocType> {\r\n    /**\r\n     * These properties are private to ensure they cannot\r\n     * be read without first processing the lazy tasks.\r\n     */\r\n    private subs: Subscription[] = [];\r\n    private counter: number = 0;\r\n    private eventCounterMap: WeakMap<\r\n        RxChangeEvent<RxDocType>, number\r\n    > = new WeakMap();\r\n    /**\r\n     * array with changeEvents\r\n     * starts with oldest known event, ends with newest\r\n    */\r\n    private buffer: RxChangeEvent<RxDocType>[] = [];\r\n\r\n    public limit: number = 100;\r\n\r\n\r\n\r\n    private tasks = new Set<Function>();\r\n\r\n    constructor(\r\n        public collection: RxCollection\r\n    ) {\r\n        this.subs.push(\r\n            this.collection.database.eventBulks$.pipe(\r\n                filter(changeEventBulk => changeEventBulk.collectionName === this.collection.name),\r\n                filter(bulk => {\r\n                    const first = bulk.events[0];\r\n                    return !first.isLocal;\r\n                })\r\n            ).subscribe(eventBulk => {\r\n                this.tasks.add(() => this._handleChangeEvents(eventBulk.events));\r\n                if (this.tasks.size <= 1) {\r\n                    requestIdlePromiseNoQueue().then(() => {\r\n                        this.processTasks();\r\n                    });\r\n                }\r\n            })\r\n        );\r\n    }\r\n\r\n    private processTasks() {\r\n        if (this.tasks.size === 0) {\r\n            return;\r\n        }\r\n        const tasks = Array.from(this.tasks);\r\n        tasks.forEach(task => task());\r\n        this.tasks.clear();\r\n    }\r\n\r\n    private _handleChangeEvents(events: RxChangeEvent<RxDocType>[]) {\r\n        const counterBefore = this.counter;\r\n        this.counter = this.counter + events.length;\r\n        if (events.length > this.limit) {\r\n            this.buffer = events.slice(events.length * -1);\r\n        } else {\r\n            appendToArray(this.buffer, events);\r\n            this.buffer = this.buffer.slice(this.limit * -1);\r\n        }\r\n        const counterBase = counterBefore + 1;\r\n        const eventCounterMap = this.eventCounterMap;\r\n        for (let index = 0; index < events.length; index++) {\r\n            const event = events[index];\r\n            eventCounterMap.set(event, counterBase + index);\r\n        }\r\n    }\r\n\r\n    getCounter() {\r\n        this.processTasks();\r\n        return this.counter;\r\n    }\r\n    getBuffer() {\r\n        this.processTasks();\r\n        return this.buffer;\r\n    }\r\n\r\n    /**\r\n     * gets the array-index for the given pointer\r\n     * @return arrayIndex which can be used to iterate from there. If null, pointer is out of lower bound\r\n     */\r\n    getArrayIndexByPointer(pointer: number): number | null {\r\n        this.processTasks();\r\n        const oldestEvent = this.buffer[0];\r\n        const oldestCounter = this.eventCounterMap.get(\r\n            oldestEvent\r\n        ) as number;\r\n\r\n        if (pointer < oldestCounter)\r\n            return null; // out of bounds\r\n\r\n        const rest = pointer - oldestCounter;\r\n        return rest;\r\n    }\r\n\r\n    /**\r\n     * get all changeEvents which came in later than the pointer-event\r\n     * @return array with change-events. If null, pointer out of bounds\r\n     */\r\n    getFrom(pointer: number): RxChangeEvent<RxDocType>[] | null {\r\n        this.processTasks();\r\n        const ret = [];\r\n        let currentIndex = this.getArrayIndexByPointer(pointer);\r\n        if (currentIndex === null) // out of bounds\r\n            return null;\r\n\r\n        while (true) {\r\n            const nextEvent = this.buffer[currentIndex];\r\n            currentIndex++;\r\n            if (!nextEvent) {\r\n                return ret;\r\n            } else {\r\n                ret.push(nextEvent);\r\n            }\r\n        }\r\n    }\r\n\r\n    runFrom(pointer: number, fn: Function) {\r\n        this.processTasks();\r\n        const ret = this.getFrom(pointer);\r\n        if (ret === null) {\r\n            throw new Error('out of bounds');\r\n        } else {\r\n            ret.forEach(cE => fn(cE));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * no matter how many operations are done on one document,\r\n     * only the last operation has to be checked to calculate the new state\r\n     * this function reduces the events to the last ChangeEvent of each doc\r\n     */\r\n    reduceByLastOfDoc(changeEvents: RxChangeEvent<RxDocType>[]): RxChangeEvent<RxDocType>[] {\r\n        this.processTasks();\r\n        return changeEvents.slice(0);\r\n        // TODO the old implementation was wrong\r\n        // because it did not correctly reassigned the previousData of the changeevents\r\n        // this should be added to the event-reduce library and not be done in RxDB\r\n        const docEventMap: any = {};\r\n        changeEvents.forEach(changeEvent => {\r\n            docEventMap[changeEvent.documentId] = changeEvent;\r\n        });\r\n        return Object.values(docEventMap);\r\n    }\r\n\r\n    destroy() {\r\n        this.tasks.clear();\r\n        this.subs.forEach(sub => sub.unsubscribe());\r\n    }\r\n}\r\n\r\nexport function createChangeEventBuffer<RxdocType>(\r\n    collection: RxCollection<RxdocType, any>\r\n) {\r\n    return new ChangeEventBuffer<RxdocType>(collection);\r\n}\r\n"],"mappings":"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","ignoreList":[]}